name: Start Kotlin Runner (Windows) with ngrok & Flask

on:
  workflow_dispatch:

jobs:
  start-runner:
    runs-on: windows-latest
    timeout-minutes: 240  # 4 hours max

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install flask pillow requests
        shell: powershell

      - name: Download ngrok (Windows)
        run: |
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip" -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath .
        shell: powershell

      - name: Configure ngrok auth token (paste your token here)
        run: |
          # Replace the placeholder below with your actual ngrok auth token
          .\ngrok.exe authtoken "31TWswIKgSWHAfejOFT6s8mcW69_4UCxySRXzy6Si8mDHn9zn"
        shell: powershell

      - name: Download Kotlin compiler (Windows)
        run: |
          Invoke-WebRequest -Uri "https://github.com/JetBrains/kotlin/releases/download/v1.9.10/kotlin-compiler-1.9.10.zip" -OutFile kotlinc.zip
          Expand-Archive kotlinc.zip -DestinationPath kotlinc
          $kotlincBin = (Resolve-Path "kotlinc\kotlinc\bin").Path
          Add-Content -Path $env:GITHUB_ENV -Value "KOTLINC_BIN=$kotlincBin"
          Write-Host "KOTLINC_BIN set to $kotlincBin"
        shell: powershell

      - name: Start Flask server and ngrok (background) & wait for tunnel
        run: |
          Write-Host "Starting Flask server (server.py must be at repo root)..."
          # start Flask server in background
          Start-Process -FilePath "python" -ArgumentList "server.py" -WindowStyle Hidden

          Write-Host "Starting ngrok tunnel (http 5000)..."
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "http 5000 --log=stdout" -WindowStyle Hidden

          Write-Host "Waiting for ngrok to initialize (polling http://127.0.0.1:4040/api/tunnels)..."
          $maxRetries = 40
          $ready = $false
          for ($i = 0; $i -lt $maxRetries; $i++) {
            Start-Sleep -Seconds 3
            try {
              $tunnels = Invoke-RestMethod -Method Get -Uri http://127.0.0.1:4040/api/tunnels -ErrorAction Stop
              if ($tunnels.tunnels -and $tunnels.tunnels.Count -gt 0) {
                Write-Host "Ngrok tunnels ready!"
                $ready = $true
                break
              }
            } catch {
              Write-Host "ngrok not ready yet... ($($i+1)/$maxRetries)"
            }
          }

          if (-not $ready) {
            Write-Host "ERROR: Failed to get ngrok tunnel info after waiting."
            # print ngrok log if available
            if (Test-Path .\ngrok.log) {
              Get-Content .\ngrok.log | Write-Host
            }
            exit 1
          }

          Write-Host "Ngrok tunnels:"
          $tunnels.tunnels | ForEach-Object { Write-Host $_.public_url }

          Write-Host "Server and tunnel are live. Keeping this job running up to 4 hours."
          # keep job alive until timeout-minutes or manual cancel
          $end = (Get-Date).AddHours(4)
          while ((Get-Date) -lt $end) {
            Start-Sleep -Seconds 30
          }
        shell: powershell
```0