name: Kotlin Runner with Flask & Ngrok

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: windows-latest
    timeout-minutes: 240   # 4 hours max

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python & Ngrok
        run: |
          python -m pip install --upgrade pip
          pip install flask requests
          Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath .
          .\ngrok.exe authtoken 31TWswIKgSWHAfejOFT6s8mcW69_4UCxySRXzy6Si8mDHn9zn
        shell: powershell

      - name: Start Flask server and ngrok (background)
        run: |
          Write-Host "Starting Flask server..."
          Start-Process -FilePath "python" -ArgumentList "server.py" -WindowStyle Hidden

          Write-Host "Starting ngrok tunnel..."
          Start-Process -FilePath ".\ngrok.exe" -ArgumentList "http 5000 --log=stdout" -WindowStyle Hidden

          Write-Host "Waiting for ngrok to initialize..."
          $maxRetries = 20
          $ready = $false
          for ($i = 0; $i -lt $maxRetries; $i++) {
            Start-Sleep -Seconds 3
            try {
              $tunnels = Invoke-RestMethod -Method Get -Uri http://127.0.0.1:4040/api/tunnels -ErrorAction Stop
              if ($tunnels.tunnels.Count -gt 0) {
                Write-Host "Ngrok tunnels ready!"
                $ready = $true
                break
              }
            } catch {
              Write-Host "ngrok not ready yet... ($($i+1)/$maxRetries)"
            }
          }

          if (-not $ready) {
            Write-Host "Failed to get ngrok tunnel info after waiting."
            exit 1
          }

          Write-Host "Ngrok tunnels:"
          $tunnels.tunnels | ForEach-Object { Write-Host $_.public_url }
          Write-Host "Server and tunnel are live. Keep this job running up to 4 hours."
          while ($true) { Start-Sleep -Seconds 60 }   # keep alive
        shell: powershell